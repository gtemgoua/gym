generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id             String          @id @default(cuid())
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  role           UserRole
  name           String
  email          String          @unique
  phone          String?
  passwordHash   String
  status         UserStatus      @default(ACTIVE)
  lastLoginAt    DateTime?
  memberProfile  MemberProfile?
  staffProfile   StaffProfile?
  auditLogs      AuditLog[]
  messages       MessageLog[]
  subscriptions  Subscription[]  @relation("MemberSubscriptions")
  invoices       Invoice[]
  paymentMethods PaymentMethod[]
  bookings       Booking[]
  attendances    Attendance[]
  tokens         UserToken[]
  notes          Note[]
  classTemplates ClassTemplate[] @relation("DefaultCoach")
  classEvents    ClassEvent[]    @relation("CoachAssignments")
  checkIns       Attendance[]    @relation("AttendanceStaff")
  createdNotes   Note[]         @relation("NoteCreator")
}

model MemberProfile {
  userId             String   @id
  birthdate          DateTime?
  emergencyContact   Json?
  waiverSignedAt     DateTime?
  waiverDocumentUrl  String?
  notes              String?
  status             MemberStatus @default(ACTIVE)
  stripeCustomerId   String?
  preferredLocation  String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  user               User     @relation(fields: [userId], references: [id])
  accessGrants       AccessGrant[]
}

model StaffProfile {
  id          String    @id @default(cuid())
  userId      String    @unique
  bio         String?
  payRate     Decimal?  @db.Decimal(10, 2)
  certifications String?
  user        User      @relation(fields: [userId], references: [id])
}

model Plan {
  id                  String          @id @default(cuid())
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt
  name                String
  description         String?
  price               Decimal         @db.Decimal(10, 2)
  billingPeriod       BillingPeriod
  creditsPerPeriod    Int?
  contractMonths      Int?
  cancellationPolicy  String?
  freezeRules         String?
  taxRate             Decimal?        @db.Decimal(5, 4)
  active              Boolean         @default(true)
  tags                String[]
  allowProration      Boolean         @default(true)
  allowDropIn         Boolean         @default(false)
  subscriptions       Subscription[]
}

model Subscription {
  id                    String           @id @default(cuid())
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt
  memberId              String
  planId                String
  status                SubscriptionStatus
  startDate             DateTime
  endDate               DateTime?
  nextBillingAt         DateTime?
  currentPeriodEnd      DateTime?
  paymentProvider       PaymentProvider  @default(STRIPE)
  paymentProviderSubId  String?
  cancellationRequested Boolean          @default(false)
  canceledAt            DateTime?
  delinquentSince       DateTime?
  user                  User             @relation("MemberSubscriptions", fields: [memberId], references: [id])
  plan                  Plan             @relation(fields: [planId], references: [id])
  invoices              Invoice[]
  usage                 SubscriptionUsage[]
}

model SubscriptionUsage {
  id             String      @id @default(cuid())
  subscriptionId String
  classEventId   String?
  creditsUsed    Int         @default(0)
  occurredAt     DateTime    @default(now())
  note           String?
  subscription   Subscription @relation(fields: [subscriptionId], references: [id])
  classEvent     ClassEvent?  @relation(fields: [classEventId], references: [id])
}

model Invoice {
  id                 String         @id @default(cuid())
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt
  memberId           String
  subscriptionId     String?
  amount             Decimal        @db.Decimal(10, 2)
  taxAmount          Decimal?       @db.Decimal(10, 2)
  discountAmount     Decimal?       @db.Decimal(10, 2)
  currency           String         @default("USD")
  status             InvoiceStatus
  dueAt              DateTime
  paidAt             DateTime?
  providerInvoiceId  String?
  providerReceiptUrl String?
  lineItems          Json
  metadata           Json?
  member             User           @relation(fields: [memberId], references: [id])
  subscription       Subscription?  @relation(fields: [subscriptionId], references: [id])
  payments           PaymentLog[]
}

model PaymentLog {
  id             String    @id @default(cuid())
  createdAt      DateTime  @default(now())
  invoiceId      String
  amount         Decimal   @db.Decimal(10, 2)
  status         PaymentStatus
  provider       PaymentProvider @default(STRIPE)
  providerRef    String?
  paidAt         DateTime?
  metadata       Json?
  invoice        Invoice   @relation(fields: [invoiceId], references: [id])
}

model PaymentMethod {
  id             String    @id @default(cuid())
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  memberId       String
  provider       PaymentProvider @default(STRIPE)
  providerPmToken String
  brand          String?
  last4          String?
  expMonth       Int?
  expYear        Int?
  default        Boolean   @default(false)
  member         User      @relation(fields: [memberId], references: [id])
}

model ClassTemplate {
  id               String        @id @default(cuid())
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  name             String
  description      String?
  defaultCoachId   String?
  defaultCapacity  Int           @default(20)
  defaultDuration  Int           @default(60) // minutes
  creditCost       Int           @default(1)
  category         String?
  color            String?
  location         String?
  room             String?
  recurrenceRule   String?
  coach            User?         @relation("DefaultCoach", fields: [defaultCoachId], references: [id])
  events           ClassEvent[]
}

model ClassEvent {
  id             String         @id @default(cuid())
  templateId     String?
  startAt        DateTime
  endAt          DateTime
  coachId        String?
  capacity       Int
  waitlistSize   Int            @default(0)
  location       String
  room           String?
  status         ClassStatus    @default(SCHEDULED)
  notes          String?
  template       ClassTemplate? @relation(fields: [templateId], references: [id])
  coach          User?          @relation("CoachAssignments", fields: [coachId], references: [id])
  bookings       Booking[]
  attendance     Attendance[]
  usage          SubscriptionUsage[]
}

model Booking {
  id              String       @id @default(cuid())
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  classEventId    String
  memberId        String
  status          BookingStatus
  consumedCredit  Boolean      @default(false)
  source          String?
  notes           String?
  classEvent      ClassEvent   @relation(fields: [classEventId], references: [id])
  member          User         @relation(fields: [memberId], references: [id])
}

model Attendance {
  id          String       @id @default(cuid())
  classEventId String
  memberId    String
  checkinAt   DateTime     @default(now())
  method      AttendanceMethod
  staffId     String?
  status      AttendanceStatus @default(PRESENT)
  classEvent  ClassEvent   @relation(fields: [classEventId], references: [id])
  member      User         @relation(fields: [memberId], references: [id])
  staff       User?        @relation("AttendanceStaff", fields: [staffId], references: [id])
}

model Lead {
  id          String    @id @default(cuid())
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  name        String
  email       String?
  phone       String?
  source      String?
  stage       LeadStage @default(LEAD)
  notes       String?
  tags        String[]
  activities  LeadActivity[]
}

model LeadActivity {
  id        String   @id @default(cuid())
  leadId    String
  type      LeadActivityType
  details   Json?
  occurredAt DateTime @default(now())
  lead      Lead     @relation(fields: [leadId], references: [id])
}

model MessageTemplate {
  id        String          @id @default(cuid())
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt
  key       String          @unique
  channel   MessageChannel
  subject   String?
  body      String
  metadata  Json?
  messages  MessageLog[]
}

model MessageLog {
  id              String          @id @default(cuid())
  createdAt       DateTime        @default(now())
  templateId      String?
  recipientId     String?
  channel         MessageChannel
  toAddress       String
  status          MessageStatus
  payload         Json
  error           String?
  template        MessageTemplate? @relation(fields: [templateId], references: [id])
  recipient       User?            @relation(fields: [recipientId], references: [id])
}

model AccessGrant {
  id            String         @id @default(cuid())
  memberId      String
  status        AccessStatus   @default(ALLOWED)
  lastSyncAt    DateTime?
  externalRef   String?
  syncedPayload Json?
  member        MemberProfile  @relation(fields: [memberId], references: [userId])
}

model AuditLog {
  id          String     @id @default(cuid())
  createdAt   DateTime   @default(now())
  userId      String?
  actorEmail  String?
  action      String
  target      String?
  metadata    Json?
  ipAddress   String?
  user        User?      @relation(fields: [userId], references: [id])
}

model UserToken {
  id          String        @id @default(cuid())
  userId      String
  token       String        @unique
  issuedAt    DateTime      @default(now())
  expiresAt   DateTime
  purpose     TokenPurpose
  user        User          @relation(fields: [userId], references: [id])
}

model Note {
  id          String      @id @default(cuid())
  userId      String
  body        String
  createdAt   DateTime    @default(now())
  createdById String?
  user        User        @relation(fields: [userId], references: [id])
  createdBy   User?       @relation("NoteCreator", fields: [createdById], references: [id])
}

enum UserRole {
  OWNER
  MANAGER
  STAFF
  MEMBER
}

enum UserStatus {
  ACTIVE
  INACTIVE
  INVITED
  SUSPENDED
}

enum MemberStatus {
  ACTIVE
  TRIAL
  FROZEN
  DELINQUENT
  CANCELED
}

enum BillingPeriod {
  WEEKLY
  MONTHLY
  QUARTERLY
  ANNUAL
  DROP_IN
}

enum SubscriptionStatus {
  ACTIVE
  TRIALING
  PAST_DUE
  CANCELED
  PAUSED
}

enum PaymentProvider {
  STRIPE
  SQUARE
  AUTHORIZE_NET
}

enum InvoiceStatus {
  DRAFT
  OPEN
  PAID
  VOID
  UNCOLLECTIBLE
}

enum BookingStatus {
  BOOKED
  WAITLISTED
  CANCELED
  NO_SHOW
}

enum AttendanceMethod {
  KIOSK
  STAFF
  API
}

enum AttendanceStatus {
  PRESENT
  LATE
  BLOCKED
}

enum LeadStage {
  LEAD
  TRIAL
  MEMBER
  LOST
}

enum LeadActivityType {
  NOTE
  CALL
  EMAIL
  TAG_UPDATE
  STATUS_CHANGE
}

enum MessageChannel {
  EMAIL
  SMS
  WEBHOOK
}

enum MessageStatus {
  QUEUED
  SENT
  FAILED
}

enum PaymentStatus {
  SUCCEEDED
  FAILED
  PENDING
}

enum AccessStatus {
  ALLOWED
  BLOCKED
}

enum ClassStatus {
  SCHEDULED
  CANCELED
  COMPLETED
}

enum TokenPurpose {
  PASSWORD_RESET
  EMAIL_VERIFICATION
  API_KEY
}
